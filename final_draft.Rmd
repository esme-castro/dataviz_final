---
title: "Final_Draft"
author: "Esme, Zach, & Mandi"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(edld652)
library(tidyverse)
library(janitor)
library(here)
library(rio)
library(maps)
```

```{r load-data}
######## Load CLASS data, clean, & select columns ########################
class <- import(here("data", "Class20032019.xlsx")) %>% 
  janitor::clean_names() # CLASS Data Set

class <- class %>% 
  rename(fips = stfips,
         state_abbr = state) # make class data a fips to match grad_rates df, same with the state abbreviation.

class <- class %>% 
  select(1:3, 6, 18, 47)

######## Load grad_rates, clean, & select columns ##########################
grad_rates <- get_data("EDFacts_acgr_lea_2011_2019") %>% 
  janitor::clean_names() # graduation rates (and cohorts)

grad_rates <- grad_rates %>% 
  mutate(fips = readr::parse_number(fipst)) #rename fipst to fips

grad_rates <- grad_rates %>% 
  select(1:8, 10, 12:27, 30)

####### Merge CLASS with grad_rates df ######################################
class_grads <- left_join(grad_rates, class, by = "fips") # class df w/ grad rates&state

####### Load state_info, clean, & select columns ############################
state_info <- readr::read_csv("https://github.com/kjhealy/fips-codes/raw/master/state_fips_master.csv") #state data with fipst

state_info <- state_info %>% 
   mutate(state_name = tolower(state_name)) %>% 
    rename(state = state_name)

state_info <- subset(state_info, select = c(1, 4, 6, 7, 9, 10))
# just want the columns with unrepeated information to class_grad that can be used later (example: regions and divisions)

###### Merge class_grads with state_info data ##################################
data <- left_join(class_grads, state_info) # this has grad rates and state info
```

```{r fiscal-data}
fiscal10 <- get_data("NCES_CCD_fiscal_district_2010") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2011") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2012") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2013") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2014") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2015") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2016") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2017") %>% 
  janitor::clean_names()

fiscal11 <- get_data("NCES_CCD_fiscal_district_2018") %>% 
  janitor::clean_names()
```








<!-- Working on fiscal data here -->
Did Daniel show you a way to get around these large file sizes? We need all years of that fiscal data in one df that can be joined to grad_rates (after we merge CLASS data too) to make our finaized df.
```{r fiscal-data}
fiscal10 <- get_data("NCES_CCD_fiscal_district_2010") %>% 
  janitor::clean_names() # Esme, this is JUST 2010 fiscal data. It is a huge data set... We still need to import and merge all of these together and then to other dataset... Didn't Dr. Anderson show you how to get around this??

## Zach, I see what you mean, I will email Anderson and ask if he recommends
## making it into parquet files before merging or not. Also if we need to
## expand our R memory when using the data.

fiscal11 <- get_data("NCES_CCD_fiscal_district_2011") %>% 
  janitor::clean_names()

fiscal_df <- get_fiscal_data()

arrow::write_parquet(fiscal_df, here::here("data", "fiscal_df.parquet"))


## using code below as reference for fiscal data, do not remove yet #####
# first read in the data
class <- import(here("data", "Class20032019.xlsx")) %>% 
  janitor::clean_names()

# write it out as a parquet file
arrow::write_parquet(class, here::here("data", "Class20032019.parquet"))

# read it in again
class2 <- arrow::read_parquet(here::here("data", "Class20032019.parquet"))
```


<!-- ignore below code chunk, this was trying to get geo data, use first code chunk above instead of final project data -->
################## Below is what I have tried to do to merge all data ###########
``` {r} 
class <- import(here("data", "Class20032019.xlsx")) %>% 
  janitor::clean_names() # CLASS Data Set
class <- class %>% 
  rename(fips = stfips,
         state_abbr = state) # make class data a fips that matches grad_rates df, same with the state abbreviation.
class <- class %>% 
  select(1:3, 6, 18, 47)

grad_rates <- get_data("EDFacts_acgr_lea_2011_2019") %>% 
  janitor::clean_names() # graduation rates (and cohorts)
grad_rates <- grad_rates %>% 
  mutate(fips = readr::parse_number(fipst)) #rename fipst to fips
grad_rates <- grad_rates %>% 
  select(1:8, 10, 12:27, 30)

# join grad_rates and CLASS
class_grads <- left_join(grad_rates, class, by = "fips") 
  # class df w/ grad rates_state
class_grads <- class_grads %>% 
  rename(state = stnam) # to match map df
class_grads <- class_grads %>% 
  mutate(state = tolower(state)) # to match maps df

# add state mapping data UNNEEdED IF WE CANNOT FIGURE THIS OUT
# maps <- map_data("state") %>% # ggplot2::map_data
  #select(1:5)

# state regions to maps df
state_info <- readr::read_csv("https://github.com/kjhealy/fips-codes/raw/master/state_fips_master.csv") #state data with fipst

state_info <- subset(state_info, select = c(1, 4, 6, 7, 9, 10))
# just want the columns with unrepeated information to class_grad that can be used later (example: regions and divisions)

state_info <- state_info %>% 
   mutate(state_name = tolower(state_name)) %>% 
    rename(state = state_name)

# maps <- left_join(state_info, maps, by = "state") # DO NOT NEED THIS IF WE CANNOT FIGURE OUT DF SIZE PROBLEM

#join state_data with class_grads
# this works, but the df is so large that you cannot view the df.

#class_grads.1 <- left_join(class_grads, maps, by = "state") 

# DO NOT NEED THIS IF WE CANNOT FIGURE OUT GEO DATA FRAME SIZE ISSUE
# if this is simply too large, we may have to try and work by creating plots using two separate dataframes? class_grads and state_data
```

```{r}
# FULL DATA FRAME without geographic info. Therefore, if using this, we will not be able to make maps of data viz
df <- left_join(class_grads, state_info, by = "state") 
```
